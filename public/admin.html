<!doctype html>
<html lang="ru">
<head>
    <meta charset="utf-8">
    <title>Панель администрирования</title>
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <link rel="stylesheet" href="/assets/css/ng-admin.min.css">
    <link rel="stylesheet" href="//mgcrea.github.io/angular-strap/styles/libs.min.css">
</head>
<body ng-app="myApp">
<div ui-view ></div>
<script src="/assets/js/jquery-2.2.2.min.js" type="text/javascript"></script>
<script src="/assets/js/ng-admin.min.js"></script>
<script src="/assets/js/angular-locale_ru-ru.js"></script>
<script src="/assets/js/ng-google-chart.js" type="text/javascript"></script>
<script src="/assets/js/angular-strap.js"></script>
<script src="/assets/js/angular-strap.tpl.js"></script>
<script src="/assets/js/lodash.js"></script>
<script src="/assets/js/angular-google-maps.js"></script>
<!--<script src='https://rawgit.com/angular-ui/angular-google-maps/2.1.5/dist/angular-google-maps.min.js'></script>-->
<script src="/assets/js/paging.min.js"></script>

<script type='text/javascript' >
    window.times = [
        {value:"10:00-13:00", label: "10:00-13:00", tag: 'payable'},
        {value:"13:00-16:00", label: "13:00-16:00", tag: 'payable'},
        {value:"16:00-19:00", label: "16:00-19:00", tag: 'payable'},
        {value:"19:00-22:00", label: "19:00-22:00", tag: 'payable'},
        {value:"Бесплатная", label: "Бесплатная", tag: 'free'},
    ];
    window.IN_DELIVERY = 'В доставке';
    window.NEW = 'Новый';
    window.CLARIFICATION = 'Требует уточнения';
    window.CANCELED = 'Отменен';
</script>
<script type="text/javascript">

    var d = new Date();

    var myApp = angular.module('myApp', ['ng-admin', 'googlechart', 'myApp.controllers',
        'mgcrea.ngStrap', 'uiGmapgoogle-maps', 'bw.paging']);
    myApp.config(['NgAdminConfigurationProvider', function(nga) {
        // create an admin application
        var admin = nga.application('Администрирование').baseApiUrl('/api/'); // main API endpoint;

        var role = nga.entity('roles');
        role.listView().title('Роли').fields([
            nga.field('name').isDetailLink(true).label("Название")
        ]).filters([
            nga.field('q').label('').pinned(true).attributes({ placeholder: 'Искать по названию' })
        ]);
        role.creationView().title('Создание роли').fields([
            nga.field('name').validation({ required: true, maxlength: 100 }).label("Название")
        ]);
        role.editionView().fields(role.creationView().fields()).title('Редактирование роли');
        admin.addEntity(role);

        var sessions = nga.entity('sessions');
        sessions.listView().title('Сессии').perPage(10).fields([
            nga.field('id').label("id"),
            nga.field('email').label("email"),
            nga.field('name').label("name"),
            nga.field('roles').label("roles"),
            nga.field('_accessedAt', 'date').label("_accessedAt"),
            nga.field('_createdAt', 'date').label("_createdAt"),
            nga.field('_savedAt', 'date').label("_savedAt"),
        ]).filters([
            nga.field('q').label('').pinned(true).attributes({ placeholder: 'Искать по названию' })
        ]);
        admin.addEntity(sessions);

        var audits = nga.entity('audits');
        audits.listView().title('Записи аудита').perPage(10).fields([
            nga.field('date', 'datetime').label("date").isDetailLink(true),
            nga.field('code').label("code").isDetailLink(true),
            nga.field('userEmail').label("email"),
            nga.field('userName').label("name"),
            nga.field('eventType').label("eventType"),
        ]).filters([
            nga.field('q').label('').pinned(true).attributes({ placeholder: 'Искать по коду' })
        ]).actions([]);
        audits.showView().fields([
            nga.field('date', 'date').label("id").isDetailLink(true),
            nga.field('code').label("code").isDetailLink(true),
            nga.field('userEmail').label("email"),
            nga.field('userName').label("name"),
            nga.field('eventType').label("eventType"),
            nga.field('objectVersion','text').label("objectVersion"),
        ]).title('Просмотр записи').actions(['list']);
        admin.addEntity(audits);

        // create a user entity
        var user = nga.entity('users').label('Пользователи');
        // set the fields of the user entity list view
        user.listView().title('Список пользователей').fields([
            nga.field('firstName').label("Имя").isDetailLink(true),
            nga.field('lastName').label("Фамилия").isDetailLink(true),
            nga.field('email').isDetailLink(true),
            nga.field('roles', 'reference_many').label("Роли")
                    .targetEntity(role)
                    .targetField(nga.field('name'))
                    .singleApiCall(ids => ({'id': ids }))
        ]).filters([
            nga.field('q').label('').pinned(true).attributes({ placeholder: 'Искать по имени или фамилии' }),
            nga.field('roles', 'reference').label('Роль').attributes({ placeholder: 'Выберите роль' })
                    .pinned(true)
                    .targetEntity(role)
                    .targetField(nga.field('name'))
                    .remoteComplete(true, {
                        refreshDelay: 200,
                        searchQuery: function(search) { return { q: search }; }
                    })
        ]);
        user.creationView().title('Новый пользователь').fields([
            nga.field('firstName').validation({ required: true, minlength: 3, maxlength: 100 }).label("Имя"),
            nga.field('lastName').validation({ required: true, minlength: 3, maxlength: 100 }).label("Фамилия"),
            nga.field('email', 'email').validation({ required: true }),
            nga.field('profileId').label('ID профиля'),
            nga.field('password').label('Пароль'),
            nga.field('passwordConfirm').label('Подтверждение пароля'),
            nga.field('roles', 'reference_many').label("Роли")
                    .targetEntity(role)
                    .targetField(nga.field('name'))
                    .attributes({ placeholder: 'Выберите роли...' })
                    .remoteComplete(true, {
                        refreshDelay: 300 ,
                        searchQuery: search => ({ q: search })
                    }),
            nga.field('street').label("Улица"),
            nga.field('city').label("Город"),
            nga.field('zipcode').label('Индекс').validation({ pattern: '[A-Z\-0-9]{5,10}' }),
            nga.field('phone').label("Телефон"),
            nga.field('website').label("Сайт")
                    .validation({ validator: function(value) {
                        if (!value) return;
                        if (value.indexOf('http://') !== 0) throw new Error ('Invalid url in website');
                    } })
        ]);
        // use the same fields for the editionView as for the creationView
        user.editionView().title('Редактирование пользователя').fields(user.creationView().fields());

        // add the user entity to the admin application
        admin.addEntity(user);

        var todo = nga.entity('todos');
        todo.listView().title('Задачи').fields([
            nga.field('title').isDetailLink(true).label("Название"),
            nga.field('done', 'boolean').label("Статус"),
            nga.field('createdOn').label("Создано"),
            nga.field('user', 'reference').isDetailLink(true)
                    .label('Пользователь')
                    .targetEntity(user)
                    .targetField(nga.field('lastName'))
                    .singleApiCall(ids => ({'id': ids }))
        ]).filters([
            nga.field('q').label('').pinned(true).attributes({ placeholder: 'Искать по названию' }),
            nga.field('done', 'boolean').label('Выполнена').pinned(true).attributes({ placeholder: ' ' }),
            nga.field('user', 'reference').label('Пользователь').attributes({ placeholder: 'Выберите пользователя' })
                .pinned(true)
                .targetEntity(user)
                .targetField(nga.field('lastName'))
                .remoteComplete(true, {
                    refreshDelay: 200,
                    searchQuery: function(search) { return { q: search }; }
                })
        ]);
        todo.creationView().title('Создание задачи').fields([
            nga.field('title').validation({ required: true, maxlength: 512 }).label("Название"),
            nga.field('done', 'boolean').label("Статус"),
            nga.field('user', 'reference')
                    .label('Пользователь')
                    .targetEntity(user).attributes({ placeholder: 'Выберите пользователя' })
                    .targetField(nga.field('lastName'))
                    .sortField('lastName')
                    .sortDir('ASC')
                    .validation({ required: true })
                    .remoteComplete(true, {
                        refreshDelay: 200,
                        searchQuery: search => ({ q: search })
                    })
        ]);
        todo.editionView().fields(todo.creationView().fields()).title('Редактирование задачи');
        admin.addEntity(todo);

        var news = nga.entity('news');
        news.listView().title('Новости').fields([
            nga.field('title').isDetailLink(true).label("Название"),
            nga.field('createdOn', 'datetime').label("Дата")
        ]).filters([
            nga.field('q').label('').pinned(true).attributes({ placeholder: 'Искать по новостям' })
        ]);
        news.creationView().title('Создание новости').fields([
            nga.field('title').validation({ required: true, maxlength: 512 }).label("Название"),
            nga.field('description').validation({ required: true, maxlength: 512 }).label("Описание"),
            nga.field('createdOn', 'datetime').label("Дата"),
        ]);
        news.editionView().fields(news.creationView().fields()).title('Редактирование новости');
        admin.addEntity(news);

        //********* SHOP ************
        var globalConfigs = nga.entity('globalConfigs');
        globalConfigs.listView().title('Настройки').fields([
            nga.field('name').isDetailLink(true).label("Название"),
            nga.field('deliveryGap').label("Время до ближайшей доставки"),
            nga.field('deliveryDaysRange').label("Кол-во дней в форме выбора доставки"),
        ]).filters([
        ]);
        globalConfigs.creationView().title('Настройки').fields([
            nga.field('deliveryGap', 'number').label("Время до ближайшей доставки (ч)"),
            nga.field('deliveryDaysRange', 'number').label("Кол-во дней в форме выбора доставки"),
            nga.field('sendSms', 'boolean').label("Отправлять смс о подтверждении заказа"),
            nga.field('smsTemplate', 'text').label("Шаблон смс о подтверждении заказа"),
            nga.field('smsTemplateAdmin', 'text').label("Шаблон смс о заказе, созданном менеджером"),
            nga.field('testMode', 'boolean').label("Тестовый режим"),
        ]);
        globalConfigs.editionView().fields(globalConfigs.creationView().fields()).title('Настройки');
        admin.addEntity(globalConfigs);

        var deliveryTypes = nga.entity('deliveryTypes');
        deliveryTypes.listView().title('Способы доставки').fields([
            nga.field('name').isDetailLink(true).label("Название"),
            nga.field('description').label("Описание"),
            nga.field('price', 'number').label("Цена")
        ]).filters([
        ]);
        deliveryTypes.creationView().title('Создание Способа доставки').fields([
            nga.field('name').validation({ required: true, maxlength: 512 }).label("Название"),
            nga.field('description').validation({ required: true}).label("Описание"),
            nga.field('price', 'number').label("Цена")
        ]);
        deliveryTypes.editionView().fields(deliveryTypes.creationView().fields()).title('Редактирование Способа доставки');
        admin.addEntity(deliveryTypes);

        var paymentTypes = nga.entity('paymentTypes');
        paymentTypes.listView().title('Способы оплаты').fields([
            nga.field('name').isDetailLink(true).label("Название"),
            nga.field('description').label("Описание"),
            nga.field('price', 'number').label("Цена")
        ]).filters([
        ]);
        paymentTypes.creationView().title('Создание Способа оплаты').fields([
            nga.field('name').validation({ required: true, maxlength: 512 }).label("Название"),
            nga.field('description').validation({ required: true}).label("Описание"),
            nga.field('price', 'number').label("Цена")
        ]);
        paymentTypes.editionView().fields(paymentTypes.creationView().fields()).title('Редактирование Способа оплаты');
        admin.addEntity(paymentTypes);

        var cmsposts = nga.entity('cmsposts');
        cmsposts.listView().title('Статьи').fields([
            nga.field('code').isDetailLink(true).label("Код"),
            nga.field('title').label("Заголовок"),
            nga.field('url').label("URL"),
            nga.field('active', 'boolean').label("Активность"),
        ]).filters([
        ]);
        cmsposts.creationView().title('Создание Статьи').fields([
            nga.field('code').validation({ required: true, maxlength: 512 }).label("Код"),
            nga.field('title').validation({ required: true, maxlength: 512 }).label("Заголовок"),
            nga.field('url').validation({ required: true}).label("URL"),
            nga.field('active', 'boolean').label("Активность"),
            nga.field('content', 'wysiwyg').label("Контент"),
        ]);
        cmsposts.editionView().fields(cmsposts.creationView().fields()).title('Редактирование Статьи');
        admin.addEntity(cmsposts);

        var cmspages = nga.entity('cmspages');
        cmspages.listView().title('Страницы CMS').fields([
            nga.field('code').isDetailLink(true).label("Код"),
            nga.field('title').label("Заголовок"),
            nga.field('url').label("URL"),
            nga.field('active', 'boolean').label("Активность"),
        ]).filters([
        ]);
        cmspages.creationView().title('Создание Страницы CMS').fields([
            nga.field('code').validation({ required: true, maxlength: 512 }).label("Код"),
            nga.field('title').validation({ required: true, maxlength: 512 }).label("Заголовок"),
            nga.field('url').validation({ required: true}).label("URL"),
            nga.field('active', 'boolean').label("Активность"),
            nga.field('pageContent', 'wysiwyg').label("Контент"),
            nga.field('posts', 'embedded_list').label('Статьи')
                    .targetFields([
                        nga.field('code').validation({ required: true, maxlength: 512 }).label("Код"),
                        nga.field('title').validation({ required: true, maxlength: 512 }).label("Заголовок"),
                        nga.field('url').label("URL"),
                        nga.field('active', 'boolean').label("Активность"),
                        nga.field('content', 'wysiwyg').label("Контент"),
                    ])
        ]);
        cmspages.editionView().fields(cmspages.creationView().fields()).title('Редактирование Страницы CMS');
        admin.addEntity(cmspages);

        var categories = nga.entity('categories');
        categories.listView().title('Категории').fields([
            nga.field('name').isDetailLink(true).label("Название"),
        ]).filters([
            nga.field('q').label('').pinned(true).attributes({ placeholder: 'Поиск...' })
        ]);
        categories.creationView().title('Создание Категории').fields([
            nga.field('name').validation({ required: true, maxlength: 512 }).label("Название"),
            nga.field('cmsId').label("ID"),
            nga.field('products', 'referenced_list')
                    .label('Содержимое')
                    .targetEntity(nga.entity('products'))
                    .targetReferenceField('categoryId')
                    .targetFields([
                        nga.field('name').label("Название").isDetailLink(true),
                        nga.field('price', 'number').label("Цена"),
                    ])
                    .perPage(20)
                    .sortField('name')
                    .sortDir('ASC'),
        ]);
        categories.editionView().fields(categories.creationView().fields()).title('Редактирование Категории');
        admin.addEntity(categories);

        var menus = nga.entity('menus');
        menus.listView().title('Меню').fields([
            nga.field('name').isDetailLink(true).label("Название"),
            nga.field('url').label("URL"),
            nga.field('index').label("Порядок"),
        ]).filters([
        ]);
        menus.creationView().title('Создание Меню').fields([
            nga.field('name').validation({ required: true, maxlength: 512 }).label("Название"),
            nga.field('categoryId', 'reference').label("Категория")
                    .targetEntity(categories)
                    .targetField(nga.field('name'))
                    .singleApiCall(ids => ({'id': ids })),
            nga.field('cmsPageId', 'reference').label("Страница контента")
                    .targetEntity(cmspages)
                    .targetField(nga.field('title'))
                    .singleApiCall(ids => ({'id': ids })),
            nga.field('active', 'boolean').label("Активность"),
            nga.field('index').label("Порядок"),
            nga.field('mobile').label("Отображать на мобильной"),
        ]);
        menus.editionView().fields(menus.creationView().fields()).title('Редактирование Меню');
        admin.addEntity(menus);


        var categoryPromotions =  nga.entity('categoryPromotions');
        categoryPromotions.listView().title('Акции на товарные категории').fields([
            nga.field('name').isDetailLink(true).label("Название"),
            nga.field('discountPercent').label("Скидка %"),
            nga.field('active', 'boolean').label("Активность"),
        ]).filters([
            nga.field('q').label('').pinned(true).attributes({ placeholder: 'Поиск...' })
        ]);
        categoryPromotions.creationView().title('Создание Акции').fields([
            nga.field('name').validation({ required: true, maxlength: 512 }).label("Название"),
            nga.field('message').validation({ required: true, maxlength: 512 }).label("Сообщение"),
            nga.field('discountPercent', 'number').validation({ required: true}).label("Скидка %"),
            nga.field('categoryId', 'reference').label("Категория").validation({ required: true})
                    .targetEntity(categories)
                    .targetField(nga.field('name'))
                    .singleApiCall(ids => ({'id': ids })),
            nga.field('active', 'boolean').label("Активность"),
        ]);
        categoryPromotions.editionView().fields(categoryPromotions.creationView().fields()).title('Редактирование Акции');
        admin.addEntity(categoryPromotions);


        var tags = nga.entity('tags');
        tags.listView().title('Теги').fields([
            nga.field('name').isDetailLink(true).label("Название"),
        ]).filters([
            nga.field('q').label('').pinned(true).attributes({ placeholder: 'Поиск...' })
        ]);
        tags.creationView().title('Создание Тега').fields([
            nga.field('name').validation({ required: true, maxlength: 512 }).label("Название"),
        ]);
        tags.editionView().fields(tags.creationView().fields()).title('Редактирование Тега');
        admin.addEntity(tags);

        var units = nga.entity('units');
        units.listView().title('Единицы измерения').fields([
            nga.field('name').isDetailLink(true).label("Имя"),
            nga.field('label').label("Представление"),
            nga.field('coefficient', 'number').label("Коэффициент"),
        ]).filters([
            nga.field('q').label('').pinned(true).attributes({ placeholder: 'Поиск...' })
        ]);
        units.creationView().title('Создание Единицы Измерения').fields([
            nga.field('name').validation({ required: true, maxlength: 512 }).label("Имя"),
            nga.field('label').validation({ required: true, maxlength: 512 }).label("Представление"),
            nga.field('coefficient', 'number').label("Коэффициент"),
        ]);
        units.editionView().fields(units.creationView().fields()).title('Редактирование Единицы Измерения');
        admin.addEntity(units);

        var products = nga.entity('products');
        products.listView().title('Продукты').fields([
            nga.field('code').isDetailLink(true).label("Код"),
            nga.field('name').isDetailLink(true).label("Название"),
            nga.field('price', 'number').label("Цена"),
            nga.field('unitId', 'reference').isDetailLink(true)
                    .label('Ед. изм.')
                    .targetEntity(units)
                    .targetField(nga.field('name'))
                    .singleApiCall(ids => ({'id': ids })),
            nga.field('categoryId', 'reference').isDetailLink(true)
                    .label('Категория')
                    .targetEntity(categories)
                    .targetField(nga.field('name'))
                    .singleApiCall(ids => ({'id': ids })),
            nga.field('tags', 'reference_many').label("Теги")
                    .targetEntity(tags)
                    .targetField(nga.field('name'))
                    .singleApiCall(ids => ({'id': ids })),
            nga.field('active', 'boolean').label("Активность"),
        ]).filters([
            nga.field('q').label('').pinned(true).attributes({ placeholder: 'Искать по продуктам' }),
            nga.field('categoryId', 'reference').label('Категория').attributes({ placeholder: 'Выберите категорию' })
                .pinned(true)
                .targetEntity(categories)
                .targetField(nga.field('name'))
                .remoteComplete(true, {
                    refreshDelay: 200,
                    searchQuery: function(search) { return { q: search }; }
                }),
            nga.field('tags', 'reference').label('Тег').attributes({ placeholder: 'Выберите тег' })
                .targetEntity(tags)
                .targetField(nga.field('name'))
                .remoteComplete(true, {
                    refreshDelay: 200,
                    searchQuery: function(search) { return { q: search }; }
                }),
            nga.field('active', 'boolean').label("Активность").pinned(true).attributes({ placeholder: 'Все' }),
        ]);
        products.creationView().title('Создание продукта').fields([
            nga.field('code').validation({ required: true, maxlength: 10 }).label("Код"),
            nga.field('name').validation({ required: true, maxlength: 512 }).label("Название"),
            nga.field('description', 'wysiwyg').validation({ required: true}).label("Описание"),
            nga.field('shortDescription').validation({ required: true}).label("Короткое описание"),
            nga.field('price', 'number').label("Цена"),
            nga.field('unitId', 'reference').label("Ед. изм.")
                    .targetEntity(units)
                    .targetField(nga.field('name'))
                    .singleApiCall(ids => ({'id': ids })),
            nga.field('active', 'boolean').label("Активность"),
            nga.field('additional', 'boolean').label("Вспомогательный"),
            nga.field('categoryId', 'reference').label("Категория")
                    .targetEntity(categories)
                    .targetField(nga.field('name'))
                    .singleApiCall(ids => ({'id': ids })),
            nga.field('tags', 'reference_many').label("Теги")
                .targetEntity(tags)
                .targetField(nga.field('name'))
                .attributes({ placeholder: 'Выберите тег...' })
                .remoteComplete(true, {
                    refreshDelay: 300 ,
                    searchQuery: search => ({ q: search })
                }),
        ]);
        products.editionView().fields(products.creationView().fields(),
            nga.field('preview', 'template').label('Картинка').template((entry) => `<img id ="prodImg" src="/image/product/${entry.values.id}?`+ d.getTime() +`" />`),
            nga.field('image', 'file').label('Обновить').uploadInformation({'url': '/image/'})
        ).title('Редактирование продукта');
        admin.addEntity(products);

        var reviews = nga.entity('reviews');
        reviews.listView().title('Отзывы').fields([
            nga.field('name').isDetailLink(true).label("Имя"),
            nga.field('link').label("Ссылка"),
            nga.field('productId', 'reference').isDetailLink(true)
                    .label('Товар')
                    .targetEntity(products)
                    .targetField(nga.field('name'))
                    .singleApiCall(ids => ({'id': ids })),
            nga.field('approved', 'boolean').label("Обработан"),
        ]).filters([
            nga.field('q').label('').pinned(true).attributes({ placeholder: 'Поиск' }),
        ]);
        reviews.creationView().title('Создание Отзыва').fields([
            nga.field('name').label("Имя"),
            nga.field('link').label("Ссылка"),
            nga.field('text', 'wysiwyg').label("Текст"),
            nga.field('approved', 'boolean').label("Обработан"),
            nga.field('productId', 'reference').label("Товар")
                    .targetEntity(products)
                    .targetField(nga.field('name'))
                    .singleApiCall(ids => ({'id': ids }))
        ]);
        reviews.editionView().fields(reviews.creationView().fields(),
            nga.field('preview', 'template').label('Картинка').template((entry) => `<img id="reviewImg" src="/review/image/${entry.values.id}?`+ d.getTime() +`" />`),
            nga.field('image', 'file').label('Обновить').uploadInformation({'url': '/review/image/'})
        ).title('Редактирование Отзыва');
        admin.addEntity(reviews);

        var medias = nga.entity('medias');
        medias.listView().title('Медиа').fields([
            nga.field('code').isDetailLink(true).label("Код"),
            nga.field('description').label("Описание"),
        ]).filters([
            nga.field('q').label('').pinned(true).attributes({ placeholder: 'Поиск' }),
        ]);
        medias.creationView().title('Создание медиа').fields([
            nga.field('code').validation({ required: true, maxlength: 100 }).label("Код"),
            nga.field('description').label("Описание"),
        ]);
        medias.editionView().fields(medias.creationView().fields(),
            nga.field('preview', 'template').label('Картинка').template((entry) => `<img id="mediaImg" src="/media/image/${entry.values.code}?`+ d.getTime() +`" />`),
            nga.field('image', 'file').label('Обновить').uploadInformation({'url': '/media/'})
        ).title('Редактирование медиа');
        admin.addEntity(medias);

        var colors = nga.entity('colors');
        colors.listView().title('Цвета теста').fields([
            nga.field('name').isDetailLink(true).label("Название"),
            nga.field('price', 'number').label("Цена"),
            nga.field('_default', 'boolean').label("По умолчанию")
        ]).filters([
            nga.field('q').label('').pinned(true).attributes({ placeholder: 'Искать по цветам' })
        ]);
        colors.creationView().title('Создание цвета').fields([
            nga.field('name').validation({ required: true, maxlength: 512 }).label("Название"),
            nga.field('price', 'number').label("Цена"),
            nga.field('_default', 'boolean').label("По умолчанию")
        ]);
        colors.editionView().fields(colors.creationView().fields()).title('Редактирование цвета');
        admin.addEntity(colors);

        var sauces = nga.entity('sauces');
        sauces.listView().title('Соусы').fields([
            nga.field('name').isDetailLink(true).label("Название"),
            nga.field('price', 'number').label("Цена")
        ]).filters([
            nga.field('q').label('').pinned(true).attributes({ placeholder: 'Искать по соусам' })
        ]);
        sauces.creationView().title('Создание соуса').fields([
            nga.field('name').validation({ required: true, maxlength: 512 }).label("Название"),
            nga.field('price', 'number').label("Цена")
        ]);
        sauces.editionView().fields(sauces.creationView().fields()).title('Редактирование соуса');
        admin.addEntity(sauces);

        var districts = nga.entity('districts');
        districts.listView().title('Районы').fields([
            nga.field('name').isDetailLink(true).label("Название"),
        ]).filters([
            nga.field('q').label('').pinned(true).attributes({ placeholder: 'Искать по районам' })
        ]);
        districts.creationView().title('Создание района').fields([
            nga.field('name').validation({ required: true, maxlength: 512 }).label("Название"),
            nga.field('points', 'embedded_list').label('Границы')
                    .targetFields([
                        nga.field('x').label('x'),
                        nga.field('y').label('y'),
                    ]),
        ]);
        districts.editionView().fields(districts.creationView().fields()).title('Редактирование района');
        admin.addEntity(districts);

        var customers = nga.entity('customers');
        customers.listView().title('Покупатели').fields([
            nga.field('name').isDetailLink(true).label("Имя"),
            nga.field('phone').label("Телефон"),
            nga.field('comment').label("Комментарий"),
        ]).filters([
            nga.field('q').label('').pinned(true).attributes({ placeholder: 'Искать по покупателям' })
        ]);
        customers.creationView().title('Создание покупателя').fields([
            nga.field('name').label("Имя"),
            nga.field('phone').label("Телефон"),
            nga.field('orders', 'referenced_list')
                    .label('Последние заказы')
                    .targetEntity(nga.entity('orders'))
                    .targetReferenceField('customerId')
                    .targetFields([
                        nga.field('orderNumber').label("Номер").isDetailLink(true),
                        nga.field('orderDate', 'datetime').label("Дата"),
                        nga.field('status').label("Статус"),
                        nga.field('totalPrice', 'number').label("Сумма"),
                    ])
//                    .listActions(['<ma-edit-button entry="::entry" entity="::entity" size="xs" label="Details"></ma-edit-button>'])
                    .perPage(5)
                    .sortField('orderNumber')
                    .sortDir('DESC'),
            nga.field('totalOrdered', 'number').label('Всего заказов на'),
            nga.field('commands button', 'template')
                    .label('')
                    .template('<ma-filtered-list-button label="Все заказы этого покупателя" entity-name="orders" filter="{ customerId: entry.values.id }"></ma-filtered-list-button>'),
            nga.field('comment', 'text').label("Комментарий"),
            nga.field('addresses', 'embedded_list').label('Адреса')
                    .targetFields([
                        nga.field('streetName').label('Улица'),
                        nga.field('streetNumber').label('Дом'),
                        nga.field('entrance').label('Подъезд'),
                        nga.field('flat').label('Квартира'),
                    ]),

        ]);
        customers.editionView().fields(customers.creationView().fields()).title('Редактирование покупателя');
        admin.addEntity(customers);

        var orderStatuses = [
            { value: window.NEW, label: window.NEW },
            { value: 'Обработан', label: 'Обработан' },
            { value: window.CLARIFICATION, label: window.CLARIFICATION },
            { value: window.CANCELED, label: window.CANCELED },
            { value: 'В доставке', label: 'В доставке' },
            { value: 'Доставлен', label: 'Доставлен' },
            { value: 'Не доставлен', label: 'Не доставлен' },
        ];

        var orders = nga.entity('orders');
        orders.listView().title('Заказы').perPage(10).fields([
            nga.field('orderNumber').isDetailLink(true).label("Номер"),
            nga.field('orderDate', 'datetime').label("Дата"),
            nga.field('status').label("Статус"),
            nga.field('name').label("Покупатель"),
            nga.field('phone').label("Телефон"),
            nga.field('totalPrice', 'number').label("Сумма"),
        ]).filters([
            nga.field('q').label('').pinned(true).template('<div class="input-group"><input type="text" ng-model="value" placeholder="Искать по заказам" class="form-control"></input><span class="input-group-addon"><i class="glyphicon glyphicon-search"></i></span></div>'),
            nga.field('status', 'choice').label("Статус").pinned(true).choices(orderStatuses).attributes({placeholder:'Выберите статус'}),
            nga.field('testOrder', 'boolean').label("Тестовый"),
            nga.field('deliveryDate_$gte', 'date').label("Дата доставки с"),
            nga.field('deliveryDate_$lt', 'date').label('Дата доставки до'),
            nga.field('orderDate_$gte', 'date').label("Дата заказа с"),
            nga.field('orderDate_$lt', 'date').label('Дата заказа до'),
            nga.field('customerId', 'reference').label('Покупатель').attributes({ placeholder: 'Выберите покупателя' })
                    .pinned(true)
                    .targetEntity(customers)
                    .targetField(nga.field('name'))
                    .remoteComplete(true, {
                        refreshDelay: 200,
                        searchQuery: function(search) { return { q: search }; }
                    })
        ]).batchActions([]);
        orders.creationView().title('Создание заказа').fields([
            nga.field('orderNumber').isDetailLink(true).label("Номер"),
            nga.field('orderDate', 'datetime').label("Дата"),
            nga.field('deliveryDate', 'datetime').label("Доставить").format('yyyy-MM-dd'),
            nga.field('deliveryId', 'reference').label("Способ доставки")
                    .targetEntity(deliveryTypes)
                    .targetField(nga.field('description'))
                    .singleApiCall(ids => ({'id': ids })),
            nga.field('deliveryTime', 'choice').attributes({ placeholder: 'Выберите значение' }).label("Интервал").choices(window.times),
            nga.field('status', 'choice').label("Статус").choices(orderStatuses).editable(false),
            nga.field('name').label("Имя покупателя"),
            nga.field('phone').label("Телефон"),
            nga.field('customerId', 'reference').label("Покупатель")
                    .targetEntity(customers)
                    .targetField(nga.field('name'))
                    .editable(false)
                    .singleApiCall(ids => ({'id': ids })),
            nga.field('totalPrice', 'number').label("Сумма").cssClasses('col-sm-2').format('$0.00'),
            nga.field('deliveryPrice').label('Стоимость доставки'),
            nga.field('paymentTypeId', 'reference').label("Способ оплаты")
                    .targetEntity(paymentTypes)
                    .targetField(nga.field('description'))
                    .singleApiCall(ids => ({'id': ids })),
            nga.field("streetName").label('Улица'),
            nga.field('originalStreetNumber').label("Дом").cssClasses('col-sm-2'),
            nga.field('entrance').label("Подъезд").cssClasses('col-sm-2'),
            nga.field('flat').label("Квартира").cssClasses('col-sm-2'),
            nga.field('districtId', 'reference').label("Район")
                    .targetEntity(districts)
                    .targetField(nga.field('name'))
                    .singleApiCall(ids => ({'id': ids })),
            nga.field('sauces', 'reference_many').label('')
                    .targetEntity(sauces)
                    .targetField(nga.field('name'))
                    .attributes({ placeholder: 'Выберите значение' })
                    .remoteComplete(true, {
                        refreshDelay: 300 ,
                        searchQuery: search => ({ q: search })
                    }).cssClasses('hidden'),
            nga.field('entries', 'embedded_list').label('Состав заказа')
                    .targetFields([
                        nga.field('productId', 'reference')
                                .label('Продукт').attributes({ placeholder: 'Выберите значение' })
                                .targetEntity(products)
                                .targetField(nga.field('name'))
                                .remoteComplete(true, {
                                    refreshDelay: 200,
                                    searchQuery: search => ({ q: search })
                                }),
                        nga.field('quantity', 'number').label("Количество"),
                        nga.field('colorId', 'reference')
                                .label('Цвет').attributes({ placeholder: 'Выберите значение' })
                                .targetEntity(colors)
                                .targetField(nga.field('name'))
                                .remoteComplete(true, {
                                    refreshDelay: 200,
                                    searchQuery: search => ({ q: search })
                                }),
                        nga.field('sauces', 'reference_many').label('Соусы')
                                .targetEntity(sauces)
                                .targetField(nga.field('name'))
                                .attributes({ placeholder: 'Выберите значение' })
                                .remoteComplete(true, {
                                    refreshDelay: 300 ,
                                    searchQuery: search => ({ q: search })
                                }),
                        nga.field('totalPrice').label('Цена'),
                    ]),
            nga.field('testOrder', 'boolean').label("Тестовый"),
        ]);
        orders.editionView().fields(orders.creationView().fields()).title('Редактирование заказа').actions(['list']);
        admin.addEntity(orders);

        admin.menu(nga.menu()
                .addChild(nga.menu().title('Обработка заказов').icon('<span class="glyphicon glyphicon-earphone"></span>').link('/arm/').active(function(path) {
                    return path.indexOf('/arm/') === 0;
                }))
                .addChild(nga.menu().title('График доставки').icon('<span class="glyphicon glyphicon-calendar"></span>').link('/schedule/').active(function(path) {
                    return path.indexOf('/schedule/') === 0;
                }))
                .addChild(nga.menu(orders).icon('<span class="glyphicon glyphicon-shopping-cart"></span>').title('Все заказы'))
                .addChild(nga.menu().title('Справочники')
                    .addChild(nga.menu(paymentTypes).icon('<span class="glyphicon glyphicon-ruble"></span>').title('Способы оплаты'))
                    .addChild(nga.menu(deliveryTypes).icon('<span class="glyphicon glyphicon-plane"></span>').title('Способы доставки'))
                    .addChild(nga.menu(products).icon('<span class="glyphicon glyphicon-cutlery"></span>').title('Товары'))
                    .addChild(nga.menu(categories).icon('<span class="glyphicon glyphicon-folder-open"></span>').title('Категории'))
                    .addChild(nga.menu(tags).icon('<span class="glyphicon glyphicon-tags"></span>').title('Теги'))
                    <!--.addChild(nga.menu(colors).icon('<span class="glyphicon glyphicon-cutlery"></span>').title('Цвета теста'))-->
                    <!--.addChild(nga.menu(sauces).icon('<span class="glyphicon glyphicon-cutlery"></span>').title('Соусы'))-->
                    .addChild(nga.menu(districts).icon('<span class="glyphicon glyphicon-map-marker"></span>').title('Районы'))
                    .addChild(nga.menu(units).icon('<span class="glyphicon glyphicon-inbox"></span>').title('Ед. изм.'))
                )
                .addChild(nga.menu().title('CMS')
                    .addChild(nga.menu(menus).icon('<span class="glyphicon glyphicon-menu-hamburger"></span>').title('Меню'))
                    .addChild(nga.menu(medias).icon('<span class="glyphicon glyphicon-picture"></span>').title('Медиа'))
                    .addChild(nga.menu(cmspages).icon('<span class="glyphicon glyphicon-list-alt"></span>').title('Страницы CMS'))
                )
                .addChild(nga.menu().title('Маркетинг').icon('<span class="glyphicon glyphicon-cog"></span>')
                    .addChild(nga.menu(customers).icon('<span class="glyphicon glyphicon-king"></span>').title('Покупатели'))
                    .addChild(nga.menu(reviews).icon('<span class="glyphicon glyphicon-thumbs-up"></span>').title('Отзывы'))
                    .addChild(nga.menu(categoryPromotions).icon('<span class="glyphicon glyphicon-asterisk"></span>').title('Акции по категориям'))
                )
                .addChild(nga.menu().title('Отчеты').icon('<span class="glyphicon glyphicon-signal"></span>').link('/stats').active(function(path) {
                    return path.indexOf('/stats') === 0;
                }))
                <!--.addChild(nga.menu(todo).icon('<span class="glyphicon glyphicon-list-alt"></span>').title('Задачи'))-->
                <!--.addChild(nga.menu(news).icon('<span class="glyphicon glyphicon-flash"></span>').title('Новости'))-->
                .addChild(nga.menu().title('Администрирование').icon('<span class="glyphicon glyphicon-cog"></span>')
                    .addChild(nga.menu(globalConfigs).icon('<span class="glyphicon glyphicon-wrench"></span>').title('Настройки'))
                    .addChild(nga.menu(user).icon('<span class="glyphicon glyphicon-user"></span>').title('Сотрудники'))
                    .addChild(nga.menu(role).icon('<span class="glyphicon glyphicon-briefcase"></span>').title('Роли'))
                    .addChild(nga.menu(sessions).icon('<span class="glyphicon glyphicon-lamp"></span>').title('Сессии'))
                    .addChild(nga.menu(audits).icon('<span class="glyphicon glyphicon-sunglasses"></span>').title('Аудит'))
                )
                .addChild(nga.menu().link('/exit').icon('<span class="glyphicon glyphicon-log-out"></span>').title('Выход'))
        );

        admin.dashboard(nga.dashboard().template($('#dashboardTemplate').html())
            .addCollection(nga.collection(globalConfigs).name('globalConfigs').title('Настройки').fields(globalConfigs.listView().fields()))
            .addCollection(nga.collection(orders).name('orders').title('Заказы').perPage(10).fields(orders.listView().fields()))
        );

        // attach the admin application to the DOM and run it
        nga.configure(admin);

    }]);

    myApp.config(function ($stateProvider) {
        $stateProvider.state('exit', {
            parent: 'main',
            url: '/exit',
            params: { id: null },
            controller: function exitController(){},
            controllerAs: 'controller',
            template:
                '<div class="row"><div class="col-lg-12">' +
                '<ma-view-actions><ma-back-button></ma-back-button></ma-view-actions>' +
                '<div class="page-header">' +
                '<h1>Выход</h1>' +
                '</div>' +
                '</div></div>' +
                '<div class="row">' +
                '<div class="col-lg-5"><a class="btn btn-default" href="/logout">Выйти</a></div>' +
                '</div>'
        }).state('stats', {
            parent: 'main',
            url: '/stats',
            template: '<div google-chart chart="chartObject" style="height:600px; width:100%;"></div>',
            controller: 'GenericChartCtrl'
        }).state('arm', {
            parent: 'main',
            url: '/arm/:orderNo',
            templateUrl: '/assets/views/arm.html',
            controller: 'ARMCtrl'
        }).state('schedule', {
            parent: 'main',
            url: '/schedule/:date',
            templateUrl: '/assets/views/schedule.html',
            controller: 'ScheduleCtrl'
        });
    });

    angular.module('myApp.controllers', []);


</script>

<script id="dashboardTemplate" type="x-tmpl-mustache">
    <div class="row">
        <div class="col-lg-12">
            <div class="page-header">
                <h1>Главная</h1>
            </div>
        </div>
    </div>

    <div class="row dashboard-content">
        <div class="col-lg-12">
            <div class="panel panel-green">
                <ma-dashboard-panel collection="dashboardController.collections.orders" entries="dashboardController.entries.orders"></ma-dashboard-panel>
            </div>
        </div>
    </div>
    <div class="row dashboard-content">
        <div class="col-lg-12">
            <div class="panel panel-yellow">
                <ma-dashboard-panel collection="dashboardController.collections.globalConfigs" entries="dashboardController.entries.globalConfigs" datastore="dashboardController.datastore"></ma-dashboard-panel>
            </div>
            <!--<div class="panel panel-green">-->
                <!--<ma-dashboard-panel collection="dashboardController.collections.orders" entries="dashboardController.entries.orders" datastore="dashboardController.datastore"></ma-dashboard-panel>-->
            <!--</div>-->
        </div>
    </div>
</script>
<script src="/assets/scripts/arm-controller.js" type="text/javascript"></script>
<script src="/assets/scripts/chart-controller.js" type="text/javascript"></script>
<script src="/assets/scripts/schedule-controller.js" type="text/javascript"></script>

</body>
</html>
