<!doctype html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <title>Панель администрирования</title>
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <link rel="stylesheet" href="/assets/css/ng-admin.min.css">
</head>
<body ng-app="myApp">
<div ui-view></div>
<script src="/assets/js/ng-admin.min.js"></script>
<script src="https://code.angularjs.org/1.3.0-rc.2/i18n/angular-locale_ru-ru.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/angular-google-chart/0.1.0/ng-google-chart.js" type="text/javascript"></script>
<script type="text/javascript">
    var myApp = angular.module('myApp', ['ng-admin', 'googlechart']);
    myApp.config(['NgAdminConfigurationProvider', function(nga) {
        // create an admin application
        var admin = nga.application('Панель администрирования').baseApiUrl('/api/'); // main API endpoint;

        var role = nga.entity('roles');
        role.listView().title('Роли').fields([
            nga.field('name').isDetailLink(true).label("Название")
        ]).filters([
            nga.field('q').label('').pinned(true).attributes({ placeholder: 'Искать по названию' })
        ]);
        role.creationView().title('Создание роли').fields([
            nga.field('name').validation({ required: true, maxlength: 100 }).label("Название")
        ]);
        role.editionView().fields(role.creationView().fields()).title('Редактирование роли');
        admin.addEntity(role);

        // create a user entity
        var user = nga.entity('users').label('Пользователи');
        // set the fields of the user entity list view
        user.listView().title('Список пользователей').fields([
            nga.field('firstName').label("Имя").isDetailLink(true),
            nga.field('lastName').label("Фамилия").isDetailLink(true),
            nga.field('email').isDetailLink(true),
            nga.field('roles', 'reference_many').label("Роли")
                    .targetEntity(role)
                    .targetField(nga.field('name'))
                    .singleApiCall(ids => ({'id': ids }))
        ]).filters([
            nga.field('q').label('').pinned(true).attributes({ placeholder: 'Искать по имени или фамилии' }),
            nga.field('roles', 'reference').label('Роль').attributes({ placeholder: 'Выберите роль' })
                    .pinned(true)
                    .targetEntity(role)
                    .targetField(nga.field('name'))
                    .remoteComplete(true, {
                        refreshDelay: 200,
                        searchQuery: function(search) { return { q: search }; }
                    })
        ]);
        user.creationView().title('Новый пользователь').fields([
            nga.field('firstName').validation({ required: true, minlength: 3, maxlength: 100 }).label("Имя"),
            nga.field('lastName').validation({ required: true, minlength: 3, maxlength: 100 }).label("Фамилия"),
            nga.field('email', 'email').validation({ required: true }),
            nga.field('profileId').label('ID профиля'),
            nga.field('password').label('Пароль'),
            nga.field('roles', 'reference_many').label("Роли")
                    .targetEntity(role)
                    .targetField(nga.field('name'))
                    .attributes({ placeholder: 'Выберите роли...' })
                    .remoteComplete(true, {
                        refreshDelay: 300 ,
                        searchQuery: search => ({ q: search })
                    }),
            nga.field('street').label("Улица"),
            nga.field('city').label("Город"),
            nga.field('zipcode').label('Индекс').validation({ pattern: '[A-Z\-0-9]{5,10}' }),
            nga.field('phone').label("Телефон"),
            nga.field('website').label("Сайт")
                    .validation({ validator: function(value) {
                        if (!value) return;
                        if (value.indexOf('http://') !== 0) throw new Error ('Invalid url in website');
                    } })
        ]);
        // use the same fields for the editionView as for the creationView
        user.editionView().title('Редактирование пользователя').fields(user.creationView().fields());

        // add the user entity to the admin application
        admin.addEntity(user);

        var todo = nga.entity('todos');
        todo.listView().title('Задачи').fields([
            nga.field('title').isDetailLink(true).label("Название"),
            nga.field('done', 'boolean').label("Статус"),
            nga.field('createdOn').label("Создано"),
            nga.field('user', 'reference').isDetailLink(true)
                    .label('Пользователь')
                    .targetEntity(user)
                    .targetField(nga.field('lastName'))
                    .singleApiCall(ids => ({'id': ids }))
        ]).filters([
            nga.field('q').label('').pinned(true).attributes({ placeholder: 'Искать по названию' }),
            nga.field('done', 'boolean').label('Выполнена').pinned(true).attributes({ placeholder: ' ' }),
            nga.field('user', 'reference').label('Пользователь').attributes({ placeholder: 'Выберите пользователя' })
                .pinned(true)
                .targetEntity(user)
                .targetField(nga.field('lastName'))
                .remoteComplete(true, {
                    refreshDelay: 200,
                    searchQuery: function(search) { return { q: search }; }
                })
        ]);
        todo.creationView().title('Создание задачи').fields([
            nga.field('title').validation({ required: true, maxlength: 512 }).label("Название"),
            nga.field('done', 'boolean').label("Статус"),
            nga.field('user', 'reference')
                    .label('Пользователь')
                    .targetEntity(user).attributes({ placeholder: 'Выберите пользователя' })
                    .targetField(nga.field('lastName'))
                    .sortField('lastName')
                    .sortDir('ASC')
                    .validation({ required: true })
                    .remoteComplete(true, {
                        refreshDelay: 200,
                        searchQuery: search => ({ q: search })
                    })
        ]);
        todo.editionView().fields(todo.creationView().fields()).title('Редактирование задачи');
        admin.addEntity(todo);

        var news = nga.entity('news');
        news.listView().title('Новости').fields([
            nga.field('title').isDetailLink(true).label("Название"),
            nga.field('createdOn', 'datetime').label("Дата")
        ]).filters([
            nga.field('q').label('').pinned(true).attributes({ placeholder: 'Искать по новостям' })
        ]);
        news.creationView().title('Создание новости').fields([
            nga.field('title').validation({ required: true, maxlength: 512 }).label("Название"),
            nga.field('description').validation({ required: true, maxlength: 512 }).label("Описание"),
            nga.field('createdOn', 'datetime').label("Дата"),
        ]);
        news.editionView().fields(news.creationView().fields()).title('Редактирование новости');
        admin.addEntity(news);

        var products = nga.entity('products');
        products.listView().title('Продукты').fields([
            nga.field('name').isDetailLink(true).label("Название"),
            nga.field('description').label("Описание"),
            nga.field('price', 'number').label("Цена")
        ]).filters([
            nga.field('q').label('').pinned(true).attributes({ placeholder: 'Искать по продуктам' })
        ]);
        products.creationView().title('Создание продукта').fields([
            nga.field('name').validation({ required: true, maxlength: 512 }).label("Название"),
            nga.field('description').validation({ required: true}).label("Описание"),
            nga.field('price', 'number').label("Цена")
        ]);
        products.editionView().fields(products.creationView().fields()).title('Редактирование продукта');
        admin.addEntity(products);

        var colors = nga.entity('colors');
        colors.listView().title('Цвета теста').fields([
            nga.field('name').isDetailLink(true).label("Название"),
            nga.field('price', 'number').label("Цена")
        ]).filters([
            nga.field('q').label('').pinned(true).attributes({ placeholder: 'Искать по цветам' })
        ]);
        colors.creationView().title('Создание цвета').fields([
            nga.field('name').validation({ required: true, maxlength: 512 }).label("Название"),
            nga.field('price', 'number').label("Цена")
        ]);
        colors.editionView().fields(colors.creationView().fields()).title('Редактирование цвета');
        admin.addEntity(colors);

        var sauces = nga.entity('sauces');
        sauces.listView().title('Соусы').fields([
            nga.field('name').isDetailLink(true).label("Название"),
            nga.field('price', 'number').label("Цена")
        ]).filters([
            nga.field('q').label('').pinned(true).attributes({ placeholder: 'Искать по соусам' })
        ]);
        sauces.creationView().title('Создание соуса').fields([
            nga.field('name').validation({ required: true, maxlength: 512 }).label("Название"),
            nga.field('price', 'number').label("Цена")
        ]);
        sauces.editionView().fields(sauces.creationView().fields()).title('Редактирование соуса');
        admin.addEntity(sauces);

        admin.menu(nga.menu()
            .addChild(nga.menu(user).icon('<span class="glyphicon glyphicon-user"></span>').title('Пользователи'))
            .addChild(nga.menu(role).icon('<span class="glyphicon glyphicon-hand-right"></span>').title('Роли'))
            .addChild(nga.menu(todo).icon('<span class="glyphicon glyphicon-list-alt"></span>').title('Задачи'))
            .addChild(nga.menu(news).icon('<span class="glyphicon glyphicon-flash"></span>').title('Новости'))
            .addChild(nga.menu(products).icon('<span class="glyphicon glyphicon-cutlery"></span>').title('Продукты'))
            .addChild(nga.menu(colors).icon('<span class="glyphicon glyphicon-cutlery"></span>').title('Цвета теста'))
            .addChild(nga.menu(sauces).icon('<span class="glyphicon glyphicon-cutlery"></span>').title('Соусы'))
            .addChild(nga.menu().title('Прочее')
                    .addChild(nga.menu().title('Отчеты').link('/stats').active(function(path) {
                        return path.indexOf('/stats') === 0;
                    }))
            )
            .addChild(nga.menu().link('/exit').icon('<span class="glyphicon glyphicon-log-out"></span>').title('Выход'))
        );

        admin.dashboard(nga.dashboard()
            .addCollection(nga.collection(user).name('users').title('Пользователи').fields(user.listView().fields()))
            .addCollection(nga.collection(role).name('roles').title('Роли').fields(role.listView().fields()))
        );

        // attach the admin application to the DOM and run it
        nga.configure(admin);
    }]);

    myApp.config(function ($stateProvider) {
        $stateProvider.state('exit', {
            parent: 'main',
            url: '/exit',
            params: { id: null },
            controller: function exitController(){},
            controllerAs: 'controller',
            template:
                '<div class="row"><div class="col-lg-12">' +
                '<ma-view-actions><ma-back-button></ma-back-button></ma-view-actions>' +
                '<div class="page-header">' +
                '<h1>Выход</h1>' +
                '</div>' +
                '</div></div>' +
                '<div class="row">' +
                '<div class="col-lg-5"><a class="btn btn-default" href="/">Выйти</a></div>' +
                '</div>'
        });
    });

    myApp.config(function ($stateProvider) {
        $stateProvider.state('stats', {
            parent: 'main',
            url: '/stats',
            template: '<div google-chart chart="chartObject" style="height:600px; width:100%;"></div>',
            controller: 'GenericChartCtrl'
        });
    });

    myApp.controller("GenericChartCtrl", function ($scope) {
        $scope.chartObject = {};

        $scope.chartObject.type = "PieChart";

        $scope.chartObject.data = [
            ['Товары', 'Объем продаж'],
            ['Наркотики',     11],
            ['Журналы',  2],
            ['Венки', 2],
            ['Цветы',    7]
        ]

        $scope.chartObject.options = {
            'title': 'Продажи',
            is3D: true
        };
    });

</script>

</body>
</html>