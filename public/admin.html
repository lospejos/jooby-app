<!doctype html>
<html lang="ru">
<head>
    <meta charset="utf-8">
    <title>Панель администрирования</title>
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <link rel="stylesheet" href="/assets/css/ng-admin.min.css">
</head>
<body ng-app="myApp">
<div ui-view ></div>
<script src="/assets/js/jquery-2.2.2.min.js" type="text/javascript"></script>
<script src="/assets/js/ng-admin.min.js"></script>
<script src="/assets/js/angular-locale_ru-ru.js"></script>
<script src="/assets/js/ng-google-chart.js" type="text/javascript"></script>
<script src="/assets/js/angular-strap.js"></script>
<script src="/assets/js/angular-strap.tpl.js"></script>
<script src="/assets/js/ui-bootstrap-2.3.1.min.js"></script>

<script type='text/javascript' >
    window.times = [
        {value:"10:00-13:00", label: "10:00-13:00"},
        {value:"13:00-16:00", label: "13:00-16:00"},
        {value:"16:00-19:00", label: "16:00-19:00"},
        {value:"19:00-22:00", label: "19:00-22:00"},
    ];
</script>
<script type="text/javascript">
    var myApp = angular.module('myApp', ['ng-admin', 'googlechart', 'myApp.controllers', 'mgcrea.ngStrap', 'ui.bootstrap']);
    myApp.config(['NgAdminConfigurationProvider', function(nga) {
        // create an admin application
        var admin = nga.application('Панель администрирования').baseApiUrl('/api/'); // main API endpoint;

        var role = nga.entity('roles');
        role.listView().title('Роли').fields([
            nga.field('name').isDetailLink(true).label("Название")
        ]).filters([
            nga.field('q').label('').pinned(true).attributes({ placeholder: 'Искать по названию' })
        ]);
        role.creationView().title('Создание роли').fields([
            nga.field('name').validation({ required: true, maxlength: 100 }).label("Название")
        ]);
        role.editionView().fields(role.creationView().fields()).title('Редактирование роли');
        admin.addEntity(role);

        // create a user entity
        var user = nga.entity('users').label('Пользователи');
        // set the fields of the user entity list view
        user.listView().title('Список пользователей').fields([
            nga.field('firstName').label("Имя").isDetailLink(true),
            nga.field('lastName').label("Фамилия").isDetailLink(true),
            nga.field('email').isDetailLink(true),
            nga.field('roles', 'reference_many').label("Роли")
                    .targetEntity(role)
                    .targetField(nga.field('name'))
                    .singleApiCall(ids => ({'id': ids }))
        ]).filters([
            nga.field('q').label('').pinned(true).attributes({ placeholder: 'Искать по имени или фамилии' }),
            nga.field('roles', 'reference').label('Роль').attributes({ placeholder: 'Выберите роль' })
                    .pinned(true)
                    .targetEntity(role)
                    .targetField(nga.field('name'))
                    .remoteComplete(true, {
                        refreshDelay: 200,
                        searchQuery: function(search) { return { q: search }; }
                    })
        ]);
        user.creationView().title('Новый пользователь').fields([
            nga.field('firstName').validation({ required: true, minlength: 3, maxlength: 100 }).label("Имя"),
            nga.field('lastName').validation({ required: true, minlength: 3, maxlength: 100 }).label("Фамилия"),
            nga.field('email', 'email').validation({ required: true }),
            nga.field('profileId').label('ID профиля'),
            nga.field('password').label('Пароль'),
            nga.field('roles', 'reference_many').label("Роли")
                    .targetEntity(role)
                    .targetField(nga.field('name'))
                    .attributes({ placeholder: 'Выберите роли...' })
                    .remoteComplete(true, {
                        refreshDelay: 300 ,
                        searchQuery: search => ({ q: search })
                    }),
            nga.field('street').label("Улица"),
            nga.field('city').label("Город"),
            nga.field('zipcode').label('Индекс').validation({ pattern: '[A-Z\-0-9]{5,10}' }),
            nga.field('phone').label("Телефон"),
            nga.field('website').label("Сайт")
                    .validation({ validator: function(value) {
                        if (!value) return;
                        if (value.indexOf('http://') !== 0) throw new Error ('Invalid url in website');
                    } })
        ]);
        // use the same fields for the editionView as for the creationView
        user.editionView().title('Редактирование пользователя').fields(user.creationView().fields());

        // add the user entity to the admin application
        admin.addEntity(user);

        var todo = nga.entity('todos');
        todo.listView().title('Задачи').fields([
            nga.field('title').isDetailLink(true).label("Название"),
            nga.field('done', 'boolean').label("Статус"),
            nga.field('createdOn').label("Создано"),
            nga.field('user', 'reference').isDetailLink(true)
                    .label('Пользователь')
                    .targetEntity(user)
                    .targetField(nga.field('lastName'))
                    .singleApiCall(ids => ({'id': ids }))
        ]).filters([
            nga.field('q').label('').pinned(true).attributes({ placeholder: 'Искать по названию' }),
            nga.field('done', 'boolean').label('Выполнена').pinned(true).attributes({ placeholder: ' ' }),
            nga.field('user', 'reference').label('Пользователь').attributes({ placeholder: 'Выберите пользователя' })
                .pinned(true)
                .targetEntity(user)
                .targetField(nga.field('lastName'))
                .remoteComplete(true, {
                    refreshDelay: 200,
                    searchQuery: function(search) { return { q: search }; }
                })
        ]);
        todo.creationView().title('Создание задачи').fields([
            nga.field('title').validation({ required: true, maxlength: 512 }).label("Название"),
            nga.field('done', 'boolean').label("Статус"),
            nga.field('user', 'reference')
                    .label('Пользователь')
                    .targetEntity(user).attributes({ placeholder: 'Выберите пользователя' })
                    .targetField(nga.field('lastName'))
                    .sortField('lastName')
                    .sortDir('ASC')
                    .validation({ required: true })
                    .remoteComplete(true, {
                        refreshDelay: 200,
                        searchQuery: search => ({ q: search })
                    })
        ]);
        todo.editionView().fields(todo.creationView().fields()).title('Редактирование задачи');
        admin.addEntity(todo);

        var news = nga.entity('news');
        news.listView().title('Новости').fields([
            nga.field('title').isDetailLink(true).label("Название"),
            nga.field('createdOn', 'datetime').label("Дата")
        ]).filters([
            nga.field('q').label('').pinned(true).attributes({ placeholder: 'Искать по новостям' })
        ]);
        news.creationView().title('Создание новости').fields([
            nga.field('title').validation({ required: true, maxlength: 512 }).label("Название"),
            nga.field('description').validation({ required: true, maxlength: 512 }).label("Описание"),
            nga.field('createdOn', 'datetime').label("Дата"),
        ]);
        news.editionView().fields(news.creationView().fields()).title('Редактирование новости');
        admin.addEntity(news);

        //********* SHOP ************
        var globalConfigs = nga.entity('globalConfigs');
        globalConfigs.listView().title('Настройки').fields([
            nga.field('name').isDetailLink(true).label("Название"),
            nga.field('deliveryGap').label("Время до ближайшей доставки"),
            nga.field('deliveryDaysRange').label("Кол-во дней в форме выбора доставки"),
        ]).filters([
        ]);
        globalConfigs.creationView().title('Настройки').fields([
            nga.field('deliveryGap', 'number').label("Время до ближайшей доставки (ч)"),
            nga.field('deliveryDaysRange', 'number').label("Кол-во дней в форме выбора доставки"),
        ]);
        globalConfigs.editionView().fields(globalConfigs.creationView().fields()).title('Настройки');
        admin.addEntity(globalConfigs);

        var deliveryTypes = nga.entity('deliveryTypes');
        deliveryTypes.listView().title('Способы доставки').fields([
            nga.field('name').isDetailLink(true).label("Название"),
            nga.field('description').label("Описание"),
            nga.field('price', 'number').label("Цена")
        ]).filters([
        ]);
        deliveryTypes.creationView().title('Создание Способа доставки').fields([
            nga.field('name').validation({ required: true, maxlength: 512 }).label("Название"),
            nga.field('description').validation({ required: true}).label("Описание"),
            nga.field('price', 'number').label("Цена")
        ]);
        deliveryTypes.editionView().fields(deliveryTypes.creationView().fields()).title('Редактирование Способа доставки');
        admin.addEntity(deliveryTypes);

        var paymentTypes = nga.entity('paymentTypes');
        paymentTypes.listView().title('Способы оплаты').fields([
            nga.field('name').isDetailLink(true).label("Название"),
            nga.field('description').label("Описание"),
            nga.field('price', 'number').label("Цена")
        ]).filters([
        ]);
        paymentTypes.creationView().title('Создание Способа оплаты').fields([
            nga.field('name').validation({ required: true, maxlength: 512 }).label("Название"),
            nga.field('description').validation({ required: true}).label("Описание"),
            nga.field('price', 'number').label("Цена")
        ]);
        paymentTypes.editionView().fields(paymentTypes.creationView().fields()).title('Редактирование Способа оплаты');
        admin.addEntity(paymentTypes);

        var products = nga.entity('products');
        products.listView().title('Продукты').fields([
            nga.field('name').isDetailLink(true).label("Название"),
            nga.field('description').label("Описание"),
            nga.field('price', 'number').label("Цена")
        ]).filters([
            nga.field('q').label('').pinned(true).attributes({ placeholder: 'Искать по продуктам' })
        ]);
        products.creationView().title('Создание продукта').fields([
            nga.field('name').validation({ required: true, maxlength: 512 }).label("Название"),
            nga.field('description', 'wysiwyg').validation({ required: true}).label("Описание"),
            nga.field('price', 'number').label("Цена")
        ]);
        products.editionView().fields(products.creationView().fields()).title('Редактирование продукта');
        admin.addEntity(products);

        var colors = nga.entity('colors');
        colors.listView().title('Цвета теста').fields([
            nga.field('name').isDetailLink(true).label("Название"),
            nga.field('price', 'number').label("Цена"),
            nga.field('_default', 'boolean').label("По умолчанию")
        ]).filters([
            nga.field('q').label('').pinned(true).attributes({ placeholder: 'Искать по цветам' })
        ]);
        colors.creationView().title('Создание цвета').fields([
            nga.field('name').validation({ required: true, maxlength: 512 }).label("Название"),
            nga.field('price', 'number').label("Цена"),
            nga.field('_default', 'boolean').label("По умолчанию")
        ]);
        colors.editionView().fields(colors.creationView().fields()).title('Редактирование цвета');
        admin.addEntity(colors);

        var sauces = nga.entity('sauces');
        sauces.listView().title('Соусы').fields([
            nga.field('name').isDetailLink(true).label("Название"),
            nga.field('price', 'number').label("Цена")
        ]).filters([
            nga.field('q').label('').pinned(true).attributes({ placeholder: 'Искать по соусам' })
        ]);
        sauces.creationView().title('Создание соуса').fields([
            nga.field('name').validation({ required: true, maxlength: 512 }).label("Название"),
            nga.field('price', 'number').label("Цена")
        ]);
        sauces.editionView().fields(sauces.creationView().fields()).title('Редактирование соуса');
        admin.addEntity(sauces);

        var orderStatuses = [
            { value: 'Новый', label: 'Новый' },
            { value: 'Обработан', label: 'Обработан' },
            { value: 'Отменен', label: 'Отменен' },
            { value: 'В доставке', label: 'В доставке' },
            { value: 'Доставлен', label: 'Доставлен' },
            { value: 'Не доставлен', label: 'Не доставлен' },
        ];

        var orders = nga.entity('orders');
        orders.listView().title('Заказы').fields([
            nga.field('orderNumber').isDetailLink(true).label("Номер"),
            nga.field('orderDate', 'datetime').label("Дата"),
            nga.field('status').label("Статус"),
            nga.field('name').label("Клиент"),
            nga.field('phone').label("Телефон"),
            nga.field('totalPrice', 'number').label("Сумма"),
        ]).filters([
            nga.field('q').label('').pinned(true).template('<div class="input-group"><input type="text" ng-model="value" placeholder="Искать по заказам" class="form-control"></input><span class="input-group-addon"><i class="glyphicon glyphicon-search"></i></span></div>'),
            nga.field('status', 'choice').label("Статус").pinned(true).choices(orderStatuses).attributes({placeholder:'Выберите статус'}),
            nga.field('deliveryDate_$gte', 'date').label("Дата доставки с"),
            nga.field('deliveryDate_$lt', 'date').label('Дата доставки до'),
            nga.field('orderDate_$gte', 'date').label("Дата заказа с"),
            nga.field('orderDate_$lt', 'date').label('Дата заказа до'),
        ]);
        orders.creationView().title('Создание заказа').fields([
            nga.field('orderNumber').isDetailLink(true).label("Номер"),
            nga.field('orderDate', 'datetime').label("Дата"),
            nga.field('deliveryDate', 'datetime').label("Доставить").format('yyyy-MM-dd'),
            nga.field('deliveryTime', 'choice').label("Интервал").choices(window.times),
            nga.field('status', 'choice').label("Статус").choices(orderStatuses),
            nga.field('name').label("Клиент"),
            nga.field('totalPrice', 'number').label("Сумма").cssClasses('col-sm-2').format('$0.00'),
            nga.field('deliveryId', 'reference').label("Способ доставки")
                    .targetEntity(deliveryTypes)
                    .targetField(nga.field('description'))
                    .singleApiCall(ids => ({'id': ids })),
            nga.field('deliveryPrice').label('Стоимость доставки'),
            nga.field('paymentTypeId', 'reference').label("Способ оплаты")
                    .targetEntity(paymentTypes)
                    .targetField(nga.field('description'))
                    .singleApiCall(ids => ({'id': ids })),
            nga.field("streetName").label('Улица'),
            nga.field('streetNumber').label("Дом").cssClasses('col-sm-2'),
            nga.field('entrance').label("Подъезд").cssClasses('col-sm-2'),
            nga.field('flat').label("Квартира").cssClasses('col-sm-2'),
            nga.field('sauces', 'reference_many').label('')
                    .targetEntity(sauces)
                    .targetField(nga.field('name'))
                    .attributes({ placeholder: 'Выберите значение' })
                    .remoteComplete(true, {
                        refreshDelay: 300 ,
                        searchQuery: search => ({ q: search })
                    }).cssClasses('hidden'),
            nga.field('entries', 'embedded_list').label('Состав заказа')
                    .targetFields([
                        nga.field('productId', 'reference')
                                .label('Продукт').attributes({ placeholder: 'Выберите значение' })
                                .targetEntity(products)
                                .targetField(nga.field('name'))
                                .remoteComplete(true, {
                                    refreshDelay: 200,
                                    searchQuery: search => ({ q: search })
                                }),
                        nga.field('quantity', 'number').label("Количество"),
                        nga.field('colorId', 'reference')
                                .label('Цвет').attributes({ placeholder: 'Выберите значение' })
                                .targetEntity(colors)
                                .targetField(nga.field('name'))
                                .remoteComplete(true, {
                                    refreshDelay: 200,
                                    searchQuery: search => ({ q: search })
                                }),
                        nga.field('sauces', 'reference_many').label('Соусы')
                                .targetEntity(sauces)
                                .targetField(nga.field('name'))
                                .attributes({ placeholder: 'Выберите значение' })
                                .remoteComplete(true, {
                                    refreshDelay: 300 ,
                                    searchQuery: search => ({ q: search })
                                }),
                        nga.field('totalPrice').label('Цена'),
                    ]),
        ]);
        orders.editionView().fields(orders.creationView().fields()).title('Редактирование заказа');
        admin.addEntity(orders);

        admin.menu(nga.menu()
                .addChild(nga.menu(orders).icon('<span class="glyphicon glyphicon-shopping-cart"></span>').title('Заказы'))
                .addChild(nga.menu().title('Справочники')
                    .addChild(nga.menu(paymentTypes).icon('<span class="glyphicon glyphicon-ruble"></span>').title('Способы оплаты'))
                    .addChild(nga.menu(deliveryTypes).icon('<span class="glyphicon glyphicon-plane"></span>').title('Способы доставки'))
                    .addChild(nga.menu(products).icon('<span class="glyphicon glyphicon-cutlery"></span>').title('Продукты'))
                    .addChild(nga.menu(colors).icon('<span class="glyphicon glyphicon-cutlery"></span>').title('Цвета теста'))
                    .addChild(nga.menu(sauces).icon('<span class="glyphicon glyphicon-cutlery"></span>').title('Соусы'))
                )
                .addChild(nga.menu(globalConfigs).icon('<span class="glyphicon glyphicon-cog"></span>').title('Настройки'))
                .addChild(nga.menu().title('Отчеты').link('/stats').active(function(path) {
                    return path.indexOf('/stats') === 0;
                }))
                .addChild(nga.menu().title('Обработка заказов').link('/arm').active(function(path) {
                    return path.indexOf('/arm') === 0;
                }))
                .addChild(nga.menu(user).icon('<span class="glyphicon glyphicon-user"></span>').title('Пользователи'))
                .addChild(nga.menu(role).icon('<span class="glyphicon glyphicon-hand-right"></span>').title('Роли'))
                .addChild(nga.menu(todo).icon('<span class="glyphicon glyphicon-list-alt"></span>').title('Задачи'))
                .addChild(nga.menu(news).icon('<span class="glyphicon glyphicon-flash"></span>').title('Новости'))
                .addChild(nga.menu().link('/exit').icon('<span class="glyphicon glyphicon-log-out"></span>').title('Выход'))
        );

        admin.dashboard(nga.dashboard().template($('#dashboardTemplate').html())
            .addCollection(nga.collection(globalConfigs).name('globalConfigs').title('Настройки').fields(globalConfigs.listView().fields()))
            .addCollection(nga.collection(orders).name('orders').title('Заказы').fields(orders.listView().fields()))
        );

        // attach the admin application to the DOM and run it
        nga.configure(admin);

    }]);

    myApp.config(function ($stateProvider) {
        $stateProvider.state('exit', {
            parent: 'main',
            url: '/exit',
            params: { id: null },
            controller: function exitController(){},
            controllerAs: 'controller',
            template:
                '<div class="row"><div class="col-lg-12">' +
                '<ma-view-actions><ma-back-button></ma-back-button></ma-view-actions>' +
                '<div class="page-header">' +
                '<h1>Выход</h1>' +
                '</div>' +
                '</div></div>' +
                '<div class="row">' +
                '<div class="col-lg-5"><a class="btn btn-default" href="/">Выйти</a></div>' +
                '</div>'
        }).state('stats', {
            parent: 'main',
            url: '/stats',
            template: '<div google-chart chart="chartObject" style="height:600px; width:100%;"></div>',
            controller: 'GenericChartCtrl'
        }).state('arm', {
            parent: 'main',
            url: '/arm',
            templateUrl: 'assets/views/arm.html',
            controller: 'ARMCtrl'
        });
    });

    angular.module('myApp.controllers', []);


</script>
<script id="dashboardTemplate" type="x-tmpl-mustache">
    <div class="row">
        <div class="col-lg-12">
            <div class="page-header">
                <h1>Главная</h1>
            </div>
        </div>
    </div>

    <div class="row dashboard-content">
        <div class="col-lg-12">
            <div class="panel panel-green">
                <ma-dashboard-panel collection="dashboardController.collections.orders" entries="dashboardController.entries.orders"></ma-dashboard-panel>
            </div>
        </div>
    </div>
    <div class="row dashboard-content">
        <div class="col-lg-12">
            <div class="panel panel-yellow">
                <ma-dashboard-panel collection="dashboardController.collections.globalConfigs" entries="dashboardController.entries.globalConfigs" datastore="dashboardController.datastore"></ma-dashboard-panel>
            </div>
            <!--<div class="panel panel-green">-->
                <!--<ma-dashboard-panel collection="dashboardController.collections.orders" entries="dashboardController.entries.orders" datastore="dashboardController.datastore"></ma-dashboard-panel>-->
            <!--</div>-->
        </div>
    </div>
</script>
<script src="/assets/scripts/arm-controller.js" type="text/javascript"></script>
<script src="/assets/scripts/chart-controller.js" type="text/javascript"></script>

</body>
</html>
